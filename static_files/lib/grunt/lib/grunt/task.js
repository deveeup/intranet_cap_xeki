"use strict";function isValidMultiTaskTarget(t){return!/^_|^options$/.test(t)}function loadTask(t){loadTaskStack.push(registry),registry={tasks:[],untasks:[],meta:{info:lastInfo,filepath:t}};var r,e='Loading "'+path.basename(t)+'" tasks...',n=0;try{"function"==typeof(r=require(path.resolve(t)))&&r.call(grunt,grunt),grunt.verbose.write(e).ok(),["un",""].forEach(function(t){var r=grunt.util._.chain(registry[t+"tasks"]).uniq().sort().value();r.length>0&&(n++,grunt.verbose.writeln((t?"- ":"+ ")+grunt.log.wordlist(r)))}),0===n&&grunt.verbose.warn("No tasks were registered or unregistered.")}catch(t){grunt.log.write(e).error().verbose.error(t.stack).or.error(t)}registry=loadTaskStack.pop()||{}}function loadTasksMessage(t){0===loadTaskDepth&&(lastInfo=t),grunt.verbose.subhead("Registering "+t+" tasks.")}function loadTasks(t){try{grunt.file.glob.sync("*.{js,coffee}",{cwd:t,maxDepth:1}).forEach(function(r){loadTask(path.join(t,r))})}catch(t){grunt.log.verbose.error(t.stack).or.error(t)}}var grunt=require("../grunt"),path=require("path"),parent=grunt.util.task.create(),task=module.exports=Object.create(parent),registry={tasks:[],untasks:[],meta:{}},lastInfo,loadTaskDepth=0,errorcount;task.registerTask=function(t){registry.tasks.push(t),parent.registerTask.apply(task,arguments);var r=task._tasks[t];r.meta=grunt.util._.clone(registry.meta);var e=r.fn;return r.fn=function(t){var n=r.name;errorcount=grunt.fail.errorcount,Object.defineProperty(this,"errorCount",{enumerable:!0,get:function(){return grunt.fail.errorcount-errorcount}}),this.requires=task.requires.bind(task),this.requiresConfig=grunt.config.requires,this.options=function(){var t=[{}].concat(grunt.util.toArray(arguments)).concat([grunt.config([n,"options"])]),r=grunt.util._.extend.apply(null,t);return grunt.verbose.writeflags(r,"Options"),r};var s=e.alias||r.multi&&(!t||"*"===t)?"verbose":"log";return grunt[s].header('Running "'+this.nameArgs+'"'+(this.name!==this.nameArgs?" ("+this.name+")":"")+" task"),grunt[s].debug("Task source: "+r.meta.filepath),e.apply(this,arguments)},task},task.normalizeMultiTaskFiles=function(t,r){var e,n,s=[];if("object"===grunt.util.kindOf(t))if("src"in t||"dest"in t){n={};for(e in t)"options"!==e&&(n[e]=t[e]);s.push(n)}else if("object"===grunt.util.kindOf(t.files))for(e in t.files)s.push({src:t.files[e],dest:grunt.config.process(e)});else Array.isArray(t.files)&&grunt.util._.flatten(t.files).forEach(function(t){var r;if("src"in t||"dest"in t)s.push(t);else for(r in t)s.push({src:t[r],dest:grunt.config.process(r)})});else s.push({src:t,dest:grunt.config.process(r)});return 0===s.length?(grunt.verbose.writeln("File: "+"[no files]".yellow),[]):(s=grunt.util._(s).chain().forEach(function(t){"src"in t&&t.src&&(Array.isArray(t.src)?t.src=grunt.util._.flatten(t.src):t.src=[t.src])}).map(function(t){var r=grunt.util._.extend({},t);if(delete r.src,delete r.dest,t.expand)return grunt.file.expandMapping(t.src,t.dest,r).map(function(r){var e=grunt.util._.extend({},t);return e.orig=grunt.util._.extend({},t),e.src=grunt.config.process(r.src),e.dest=grunt.config.process(r.dest),["expand","cwd","flatten","rename","ext"].forEach(function(t){delete e[t]}),e});var e=grunt.util._.extend({},t);return e.orig=grunt.util._.extend({},t),"src"in e&&Object.defineProperty(e,"src",{enumerable:!0,get:function e(){var n;return"result"in e||(n=t.src,n=Array.isArray(n)?grunt.util._.flatten(n):[n],e.result=grunt.file.expand(r,n)),e.result}}),"dest"in e&&(e.dest=t.dest),e}).flatten().value(),grunt.option("verbose")&&s.forEach(function(t){var r=[];"src"in t&&r.push(t.src.length>0?grunt.log.wordlist(t.src):"[no src]".yellow),"dest"in t&&r.push("-> "+(t.dest?String(t.dest).cyan:"[no dest]".yellow)),r.length>0&&grunt.verbose.writeln("Files: "+r.join(" "))}),s)},task.registerMultiTask=function(t,r,e){null==e&&(e=r,r="Custom multi task.");var n;task.registerTask(t,r,function(t){var r=n.name;if(this.args=grunt.util.toArray(arguments).slice(1),!t||"*"===t)return task.runAllTargets(r,this.args);if(!isValidMultiTaskTarget(t))throw new Error('Invalid target "'+t+'" specified.');return this.requiresConfig([r,t]),this.options=function(){var e=grunt.config([r,t]),n=[{}].concat(grunt.util.toArray(arguments)).concat([grunt.config([r,"options"]),"object"===grunt.util.kindOf(e)?e.options:{}]),s=grunt.util._.extend.apply(null,n);return grunt.verbose.writeflags(s,"Options"),s},this.target=t,this.flags={},this.args.forEach(function(t){this.flags[t]=!0},this),this.data=grunt.config([r,t]),this.files=task.normalizeMultiTaskFiles(this.data,t),Object.defineProperty(this,"filesSrc",{enumerable:!0,get:function(){return grunt.util._(this.files).chain().pluck("src").flatten().uniq().value()}.bind(this)}),e.apply(this,this.args)}),(n=task._tasks[t]).multi=!0},task.registerInitTask=function(t,r,e){task.registerTask(t,r,e),task._tasks[t].init=!0},task.renameTask=function(t,r){var e;try{return e=parent.renameTask.apply(task,arguments),registry.untasks.push(t),registry.tasks.push(r),e}catch(t){grunt.log.error(t.message)}},task.runAllTargets=function(t,r){var e=Object.keys(grunt.config.getRaw(t)||{});if(0===e.length)return grunt.log.error('No "'+t+'" targets found.'),!1;e.filter(isValidMultiTaskTarget).forEach(function(e){task.run([t,e].concat(r||[]).join(":"))})};var loadTaskStack=[];task.loadTasks=function(t){loadTasksMessage('"'+t+'"'),grunt.file.exists(t)?loadTasks(t):grunt.log.error('Tasks directory "'+t+'" not found.')},task.loadNpmTasks=function(t){loadTasksMessage('"'+t+'" local Npm module');var r=path.resolve("node_modules"),e=path.join(r,t,"package.json"),n=grunt.file.exists(e)?grunt.file.readJSON(e):{keywords:[]};if(n.keywords&&-1!==n.keywords.indexOf("gruntcollection"))return loadTaskDepth++,Object.keys(n.dependencies).forEach(function(e){var n=grunt.file.findup("node_modules/"+e,{cwd:path.resolve("node_modules",t),nocase:!0});n&&task.loadNpmTasks(path.relative(r,n))}),void loadTaskDepth--;var s=path.join(r,t,"tasks");grunt.file.exists(s)?loadTasks(s):grunt.log.error('Local Npm module "'+t+'" not found. Is it installed?')},task.init=function(t,r){r||(r={});var e=t.length>0&&t.every(function(t){var r=task._taskPlusArgs(t).task;return r&&r.init}),n=e?null:grunt.option("gruntfile")||grunt.file.findup("Gruntfile.{js,coffee}",{nocase:!0}),s='Reading "'+(n?path.basename(n):"???")+'" Gruntfile...';n&&grunt.file.exists(n)?(grunt.verbose.writeln().write(s).ok(),process.chdir(grunt.option("base")||path.dirname(n)),loadTasksMessage("Gruntfile"),loadTask(n)):r.help||e||(grunt.option("gruntfile")?(grunt.log.writeln().write(s).error(),grunt.fatal('Unable to find "'+n+'" Gruntfile.',grunt.fail.code.MISSING_GRUNTFILE)):grunt.option("help")||(grunt.verbose.writeln().write(s).error(),grunt.log.writelns("A valid Gruntfile could not be found. Please see the getting started guide for more information on how to configure grunt: http://gruntjs.com/getting-started"),grunt.fatal("Unable to find Gruntfile.",grunt.fail.code.MISSING_GRUNTFILE))),(grunt.option("npm")||[]).forEach(task.loadNpmTasks),(grunt.option("tasks")||[]).forEach(task.loadTasks)};