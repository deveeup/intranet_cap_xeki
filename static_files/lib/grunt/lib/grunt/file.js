"use strict";var grunt=require("../grunt"),fs=require("fs"),path=require("path"),file=module.exports={};file.glob=require("glob"),file.minimatch=require("minimatch"),file.findup=require("findup-sync");var YAML=require("js-yaml"),rimraf=require("rimraf"),iconv=require("iconv-lite"),win32="win32"===process.platform,unixifyPath=function(r){return win32?r.replace(/\\/g,"/"):r};file.setBase=function(){var r=path.join.apply(path,arguments);process.chdir(r)};var processPatterns=function(r,e){var t=[];return grunt.util._.flatten(r).forEach(function(r){var n=0===r.indexOf("!");n&&(r=r.slice(1));var i=e(r);t=n?grunt.util._.difference(t,i):grunt.util._.union(t,i)}),t};file.match=function(r,e,t){return"object"!==grunt.util.kindOf(r)&&(t=e,e=r,r={}),null==e||null==t?[]:(Array.isArray(e)||(e=[e]),Array.isArray(t)||(t=[t]),0===e.length||0===t.length?[]:processPatterns(e,function(e){return file.minimatch.match(t,e,r)}))},file.isMatch=function(){return file.match.apply(file,arguments).length>0},file.expand=function(){var r=grunt.util.toArray(arguments),e="object"===grunt.util.kindOf(r[0])?r.shift():{},t=Array.isArray(r[0])?r[0]:r;if(0===t.length)return[];var n=processPatterns(t,function(r){return file.glob.sync(r,e)});return e.filter&&(n=n.filter(function(r){r=path.join(e.cwd||"",r);try{return"function"==typeof e.filter?e.filter(r):fs.statSync(r)[e.filter]()}catch(r){return!1}})),n};var pathSeparatorRe=/[\/\\]/g,extDotRe={first:/(\.[^\/]*)?$/,last:/(\.[^\/\.]*)?$/};file.expandMapping=function(r,e,t){t=grunt.util._.defaults({},t,{extDot:"first",rename:function(r,e){return path.join(r||"",e)}});var n=[],i={};return file.expand(t,r).forEach(function(r){var a=r;t.flatten&&(a=path.basename(a)),"ext"in t&&(a=a.replace(extDotRe[t.extDot],t.ext));var o=t.rename(e,a,t);t.cwd&&(r=path.join(t.cwd,r)),o=o.replace(pathSeparatorRe,"/"),r=r.replace(pathSeparatorRe,"/"),i[o]?i[o].src.push(r):(n.push({src:[r],dest:o}),i[o]=n[n.length-1])}),n},file.mkdir=function(r,e){grunt.option("no-write")||(null==e&&(e=parseInt("0777",8)&~process.umask()),r.split(pathSeparatorRe).reduce(function(r,t){r+=t+"/";var n=path.resolve(r);if(!file.exists(n))try{fs.mkdirSync(n,e)}catch(r){throw grunt.util.error('Unable to create directory "'+n+'" (Error code: '+r.code+").",r)}return r},""))},file.recurse=function r(e,t,n){var i=n?path.join(e,n):e;fs.readdirSync(i).forEach(function(a){var o=path.join(i,a);fs.statSync(o).isDirectory()?r(e,t,unixifyPath(path.join(n||"",a||""))):t(unixifyPath(o),e,n,a)})},file.defaultEncoding="utf8",file.preserveBOM=!1,file.read=function(r,e){e||(e={});var t;grunt.verbose.write("Reading "+r+"...");try{return t=fs.readFileSync(String(r)),null!==e.encoding&&(t=iconv.decode(t,e.encoding||file.defaultEncoding),file.preserveBOM||65279!==t.charCodeAt(0)||(t=t.substring(1))),grunt.verbose.ok(),t}catch(e){throw grunt.verbose.error(),grunt.util.error('Unable to read "'+r+'" file (Error code: '+e.code+").",e)}},file.readJSON=function(r,e){var t,n=file.read(r,e);grunt.verbose.write("Parsing "+r+"...");try{return t=JSON.parse(n),grunt.verbose.ok(),t}catch(e){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+r+'" file ('+e.message+").",e)}},file.readYAML=function(r,e){var t,n=file.read(r,e);grunt.verbose.write("Parsing "+r+"...");try{return t=YAML.load(n),grunt.verbose.ok(),t}catch(e){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+r+'" file ('+e.problem+").",e)}},file.write=function(r,e,t){t||(t={});var n=grunt.option("no-write");grunt.verbose.write((n?"Not actually writing ":"Writing ")+r+"..."),file.mkdir(path.dirname(r));try{return Buffer.isBuffer(e)||(e=iconv.encode(e,t.encoding||file.defaultEncoding)),n||fs.writeFileSync(r,e),grunt.verbose.ok(),!0}catch(e){throw grunt.verbose.error(),grunt.util.error('Unable to write "'+r+'" file (Error code: '+e.code+").",e)}},file.copy=function(r,e,t){t||(t={});var n=t.process&&!0!==t.noProcess&&!(t.noProcess&&file.isMatch(t.noProcess,r)),i=n?t:{encoding:null},a=file.read(r,i);if(n){grunt.verbose.write("Processing source...");try{a=t.process(a,r),grunt.verbose.ok()}catch(e){throw grunt.verbose.error(),grunt.util.error('Error while processing "'+r+'" file.',e)}}!1===a?grunt.verbose.writeln("Write aborted."):file.write(e,a,i)},file.delete=function(r,e){r=String(r);var t=grunt.option("no-write");if(e||(e={force:grunt.option("force")||!1}),grunt.verbose.write((t?"Not actually deleting ":"Deleting ")+r+"..."),!file.exists(r))return grunt.verbose.error(),grunt.log.warn("Cannot delete nonexistent file."),!1;if(!e.force){if(file.isPathCwd(r))return grunt.verbose.error(),grunt.fail.warn("Cannot delete the current working directory."),!1;if(!file.isPathInCwd(r))return grunt.verbose.error(),grunt.fail.warn("Cannot delete files outside the current working directory."),!1}try{return t||rimraf.sync(r),grunt.verbose.ok(),!0}catch(e){throw grunt.verbose.error(),grunt.util.error('Unable to delete "'+r+'" file ('+e.message+").",e)}},file.exists=function(){var r=path.join.apply(path,arguments);return fs.existsSync(r)},file.isLink=function(){var r=path.join.apply(path,arguments);return file.exists(r)&&fs.lstatSync(r).isSymbolicLink()},file.isDir=function(){var r=path.join.apply(path,arguments);return file.exists(r)&&fs.statSync(r).isDirectory()},file.isFile=function(){var r=path.join.apply(path,arguments);return file.exists(r)&&fs.statSync(r).isFile()},file.isPathAbsolute=function(){var r=path.join.apply(path,arguments);return path.resolve(r)===r.replace(/[\/\\]+$/,"")},file.arePathsEquivalent=function(r){r=path.resolve(r);for(var e=1;e<arguments.length;e++)if(r!==path.resolve(arguments[e]))return!1;return!0},file.doesPathContain=function(r){r=path.resolve(r);for(var e,t=1;t<arguments.length;t++)if(""===(e=path.relative(path.resolve(arguments[t]),r))||/\w+/.test(e))return!1;return!0},file.isPathCwd=function(){var r=path.join.apply(path,arguments);try{return file.arePathsEquivalent(fs.realpathSync(process.cwd()),fs.realpathSync(r))}catch(r){return!1}},file.isPathInCwd=function(){var r=path.join.apply(path,arguments);try{return file.doesPathContain(fs.realpathSync(process.cwd()),fs.realpathSync(r))}catch(r){return!1}};