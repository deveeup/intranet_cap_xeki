"use strict";var path=require("path"),EE=require("events").EventEmitter,util=require("util"),reloadTargets=[];module.exports=function(e){function t(){EE.call(this),this.name="watch",this.options={},this.done=function(){},this.targets=Object.create(null),this.queue=[],this.running=!1,this.nospawn=!1,this.reload=!1,this.nameArgs=[],this.changedFiles=Object.create(null)}var r=require("./taskrun")(e),n=require("./livereload")(e);return util.inherits(t,EE),t.prototype.init=function(t,r,o){var i=this;i.name=t||e.task.current.name||"watch",i.options=i._options(e.config([i.name,"options"])||{},r||{}),i.reload=!1,i.nameArgs=e.task.current.nameArgs?e.task.current.nameArgs:i.name,i.done=o||e.task.current.async();var a=e.config([i.name,"options","livereload"]);i.options.target&&a&&e.config([i.name,i.options.target,"options","livereload"])&&(a=!1),a&&(i.livereload=n(a));var s=i._getTargets(i.name);return i.running?i.complete():reloadTargets.length>0?(i.queue=reloadTargets,reloadTargets=[],i.run()):(i.queue=s.filter(function(e){return!0===e.options.atBegin&&e.tasks.length>0}).map(function(e){return e.name}),i.queue.length>0&&i.run()),s},t.prototype._getTargets=function(t){var r=this;e.task.current.requiresConfig(t);var n=e.config(t),o=!!r.options.target&&r.options.target,i=(o?[o]:Object.keys(n)).filter(function(e){return"options"!==e&&("string"!=typeof n[e]&&!Array.isArray(n[e]))}).map(function(n){e.task.current.requiresConfig([t,n,"files"]);var o=e.config([t,n]);return o.name=n,o.options=r._options(o.options||{},r.options),r.add(o),o},r);if("string"==typeof n.files||Array.isArray(n.files)){var a={files:n.files,tasks:n.tasks,name:"default",options:r._options(n.options||{},r.options)};i.push(a),r.add(a)}return i},t.prototype._options=function(){var t=Array.prototype.slice.call(arguments).concat({cwd:process.cwd(),cliArgs:e.util._.without.apply(null,[[].slice.call(process.argv,2)].concat(e.cli.tasks)),interrupt:!1,nospawn:!1,spawn:!0,atBegin:!1,event:["all"],target:null});return e.util._.defaults.apply(e.util._,t)},t.prototype.run=e.util._.debounce(function(){var t=this;if(t.queue.length<1)t.running=!1;else{if(t.options=t._options(e.config([t.name,"options"])||{},t.options),!0===t.running){var r=!0;if(t.queue.forEach(function(e){var n=t.targets[e];if(n&&!0!==n.options.interrupt)return r=!1,!1}),!0!==r)return;t.interrupt()}if(t.reload)return t.reloadTask();t.emit("start"),t.running=!0;var n=!0;e.util.async.forEachSeries(t.queue,function(r,o){var i=t.targets[r];if(!i)return o();i.options=t._options(e.config([t.name,r,"options"])||{},i.options,t.options),!1!==i.options.spawn&&!0!==i.options.nospawn||(n=!1),i.run(o)},function(){n?t.complete():(e.task.mark().run(t.nameArgs),t.done())})}},250),t.prototype.add=function(t){if(!this.targets[t.name||0]){var o=new r(t),i=e.config([this.name,t.name||0,"options","livereload"]);return i?o.livereload=n(i):this.livereload&&!1!==i&&(o.livereload=this.livereload),this.targets[o.name]=o}return!1},t.prototype.complete=function(){var e=this;if(!1!==e.running){e.running=!1;for(var t=0,r=0,n=e.queue.length;r<n;++r){var o=e.queue[r],i=e.targets[o];if(!i)return;!1!==i.startedAt&&(t+=i.complete(),e.queue.splice(r--,1),n--,i.options.livereload&&i.tasks.length<1&&(t+=1e-4))}var a=t>0?Number(t/1e3):0;e.changedFiles=Object.create(null),e.emit("end",a)}},t.prototype._completeQueue=function(){var e=this;e.queue.forEach(function(t){var r=e.targets[t];r&&r.complete()})},t.prototype.interrupt=function(){var t=this;t._completeQueue(),e.task.clearQueue(),t.emit("interrupt")},t.prototype.forever=function(){function t(){r._completeQueue(),e.task.clearQueue(),e.task.run(r.nameArgs),r.running=!1}var r=this;e.warn=e.fail.warn=function(r){var n="string"==typeof r?r:r.message;e.log.writeln(("Warning: "+n).yellow),e.option("force")||t()},e.fatal=e.fail.fatal=function(r){var n="string"==typeof r?r:r.message;e.log.writeln(("Fatal error: "+n).red),t()}},t.prototype.clearRequireCache=function(){("string"!=typeof arguments[0]?arguments[0]:e.util.toArray(arguments)).forEach(function(t){var r=path.resolve(t);require.cache[r]&&(e.verbose.write('Clearing require cache for "'+t+'" file...').ok(),delete require.cache[r])})},t.prototype.reloadTask=function(){var t=this;reloadTargets=t.queue,t.emit("reload",reloadTargets),e.task.init([t.name]),t._completeQueue(),e.task.run(t.nameArgs),t.done()},new t};